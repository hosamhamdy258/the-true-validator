# Egyptian National ID Validator API

A production-ready REST API for validating and extracting information from Egyptian National ID numbers.

---

## Features

### Core Functionality

- **Egyptian National ID Validation** - Validates 14-digit Egyptian national IDs
- **Information Extraction** - Extracts birth date, age, century, governorate, gender, generation, and serial number

### Authentication

- **JWT Authentication** - Secure token-based authentication
- **Token Blacklisting** - Revoke tokens on logout or security incidents
- **Short-lived Access Tokens** - 15-minute expiration
- **Rate Limiting** : According to following rules limit is per user to prevent abuse
    - 30000/Hour
    - 3000/Minute 
    - 300/Second

### Performance & Optimization

- **Caching** - 1-hour cache for validation results faster for repeated requests
- **Async Logging** - Non-blocking request logging ( using ThreadPoolExecutor )
- **Cached Validator** - Single validator instance reused across requests
- **Optimized Queries** - Database indexes for fast log retrieval

### Monitoring & Testing

- **Request Logging** - Tracks all API calls with user, IP, timestamp
- **Test Cases** - Added tests that covers most of cases
    - Throttling was to complex to test at second level added [throttle_test.py](throttle_test.py) for manual testing

### Production Ready

- **Docker Support** - Containerized deployment
- **Supervisor + Nginx + Gunicorn** - Production-grade web server setup
- **Environment-based Config** - Separate development/production settings

---

## Egyptian National ID Format

### Structure

Searched the internet and found the structure that am validating against on file [National ID Format](id_number_info.txt)

### Validation Rules

1. **Length**: Must be exactly 14 digits
2. **Century**: First digit must be 2 (1900s) or 3 (2000s)
3. **Date**: Digits 2-7 must form a valid date (YY-MM-DD)
4. **Governorate**: Digits 8-9 must be a valid governorate code (01-35)
5. **Future Dates**: Birth date cannot be in the future

### Extracted Information

The API extracts and returns the following information from valid IDs:

- **Birth Date** - Full date (YYYY-MM-DD), year, month, and day
- **Age** - Calculated age in years
- **Century** - 20th or 21st century
- **Gender** - Male or Female
- **Generation** - Generational based on birth year
- **Governorate** - Governorate with code, English name, and Arabic name
- **Serial Number** - Last 4 digits representing the unique serial

---
### Notes Before Quick Start
- used **django-ratelimit** over **django-rest-framework** throttle as they mentioned it has race condition issue [here](https://www.django-rest-framework.org/api-guide/throttling/#a-note-on-concurrency)
- following pervious point used **redis** instead of **local memory** or build in **lru decorator** as **django-ratelimit** has redis as requirement but it's over kill for small app
- logging only requests that hit database or miss caching as cached responses not counted
- **gunicorn** works limited to 4 as i was squeezing them to get most value
- implemented async logger to stop blocking operations [ **file writing or console logging** ]
- used JWT for auth over api key header as jwt support Stateless User Authentication [here](https://django-rest-framework-simplejwt.readthedocs.io/en/latest/stateless_user_authentication.html) so later can we use it for light and quick auth on internal services
- added small background for clearing expired tokens
- used small access token time as trade off exposed tokens as it's stateless so no way to revoke it easily but blacklist the refresh token so it's limited to remaining time of access token which is short
- used **ThreadPoolExecuter** instead of install **Celery** for small background job ( logging api usage )
- preloaded **ValidatorClass** as **classmethod** to prevent creating it on every request
---

## Quick Start

### if you don't want to install the app is live on [Koybe]() 

### Installation

1. **Clone the repository**

```bash
git clone <repository-url>
cd tru
```

2. **Build and run (Production)**

```bash
docker compose up production
```

3. **Access the application**

- **Testing Interface**: `http://localhost/` - Beautiful web UI for instant testing
  - I didn't write the home page, it was generated by AI
  - The home page bypasses authentication for convenient testing. The real API endpoints require JWT tokens.
- **API Endpoints**: `http://localhost/api/` - REST API with JWT authentication
- **Swagger UI**: `http://localhost/api/schema/swagger-ui/` - Interactive API docs
- **Admin Panel**: `http://localhost/admin/` - Django admin interface

### Test Users

```bash
# Admin User (auto-created)
Username: admin
Password: admin

# Test Users (auto-created, password: "test")
user1, user2, user3, user4
```

**Optional: Development Mode**

```bash
docker compose up development
# The App will be available at `http://localhost:8000`
```

---

## API Documentation & Available Endpoints

- **Home Page (Testing)**: `/` - Interactive validator (no auth required)
- **Validate national ID**: `/api/validate/` - Requires JWT authentication
- **Obtain JWT tokens**: `/api/token/`
- **Refresh access token**: `/api/token/refresh/`
- **Blacklist refresh token**: `/api/token/blacklist/`
- **Swagger UI**: `/api/schema/swagger-ui/`
- **ReDoc**: `/api/schema/redoc/`
- **Admin Panel**: `/admin/`

---

## API Usage Examples

### JavaScript (Browser/Node.js)

```javascript
// 1. Get JWT Token
fetch("http://localhost/api/token/", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    username: "admin",
    password: "admin",
  }),
})
  .then((response) => response.json())
  .then((data) => {
    const accessToken = data.access;

    // 2. Validate National ID
    return fetch("http://localhost/api/validate/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: "Bearer " + accessToken,
      },
      body: JSON.stringify({
        national_id: "29801011401891",
      }),
    });
  })
  .then((response) => response.json())
  .then((result) => {
    console.log("Validation Result:", result);
    // Output: { is_valid: true, birth_date: "1998-01-01", age: 27, ... }
  })
  .catch((error) => console.error("Error:", error));
```

### Python

```python
import pprint
import requests

# Base URL
BASE_URL = "http://localhost"

# 1. Login and get JWT tokens
response = requests.post(
    f"{BASE_URL}/api/token/",
    json={"username": "admin", "password": "admin"}
)
tokens = response.json()
access_token = tokens["access"]
refresh_token = tokens["refresh"]

# 2. Validate National ID
headers = {"Authorization": f"Bearer {access_token}"}
response = requests.post(
    f"{BASE_URL}/api/validate/",
    headers=headers,
    json={"national_id": "29801011401891"}
)
result = response.json()
pprint.pprint(result)

# Output:
# {'age': 27,
#  'birth_date': '1998-01-01',
#  'birth_day': 1,
#  'birth_month': 1,
#  'birth_year': 1998,
#  'century': '20th century (1900-1999)',
#  'errors': None,
#  'gender': 'Male',
#  'generation': {'name': 'Generation Z', 'year_range': '1997-2012'},
#  'governorate': {'code': '14',
#                  'name_arabic': 'القليوبية',
#                  'name_english': 'Qalyubia'},
#  'is_valid': True,
#  'national_id': '29801011401891',
#  'serial_number': '0189'}
```

---

## Management Commands

### Clear Validation Cache

```bash
# Clear all cache
docker compose exec production python manage.py clear_validation_cache

# Clear specific national ID cache
docker compose exec production python manage.py clear_validation_cache --national-id 29801011401891
```

### Revoke User Tokens

```bash
# Revoke all JWT tokens for a specific user
docker compose exec production python manage.py revoke_user_tokens username
```

---

## License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.

**Built with ❤️ By Hossam Hamdy**
